\chapter{Implementace úprav v migraèních nástrojích}
\section{Úvod}
Mým úkolem bylo najít zpùsob, jak pøi procesu migrace na \texttt{warc} archiv zjistit obsah pùvodního archivu. To znamená, ¾e jsem mìl v prùbìhu migrace provést analýzu obsahu archivu. V prùbìhu pøevodu znamená taková analýza nejmen¹í re¾ii, oproti dodateènému provádìní takové analýzy. Navíc by analýza mohla potencionálnì ovlivnit samotný pøevod, jeliko¾ by v pøípadì nutnosti bylo mo¾no zmìnit obsah pøevádìného archivu pøed tím, ne¾ bude ulo¾en do \texttt{warc} archivu.

Z toho dùvodu jsem musel provést nìkolik zmìn v programu \texttt{JHOVE2} i nástroji \texttt{WARC-TOOLS}, respektive jsem zmìnu provedl jen v nástroji \texttt{WARC-TOOLS / hanzo}. Zmìna v ostatních nástrojích \texttt{WARC-TOOLS} by znamenala obdobné zásahy do zdrojového kódu a pravdìpodobnì by vedla ke stejným výsledkùm, jak vyplývá z mého porovnání nástrojù.

Úprava umo¾òuje bìhem testování obsahu archivu provádìt dal¹í operace. Pøi migraci archivu dochází k tomu, ¾e pøed tím, ne¾ nástroj \texttt{arc2warc} vlo¾í do nového \texttt{warc} archivu soubor z pùvodního archivu, provede se analýza daného souboru pomocí nástroje \texttt{JHOVE2}.

V praxi bude tato varianta mého programu umo¾òovat provedení rozhodování o tom, zda daný soubor pøidat do nového \texttt{warc} archivu, nebo ho vylouèit anebo s ním umo¾ní provádìt dal¹í operace. Výstup migrace tak tvoøí nový \texttt{warc} archiv a jednotlivé analýzy v¹ech souborù obsa¾ených v archivu.
\section{Úprava \texttt{JHOVE2}}
Program \texttt{JHOVE2} je implementován v programovacím jazyce \texttt{Java}. Jeliko¾ je napsán tak, aby ho bylo mo¾né spou¹tìt z pøíkazového øádku, musel jsem provést zmìny, který by mi umo¾nili spou¹tìt jej pøímo z tìla programu \texttt{WARC-TOOLS}. Bylo tedy nutno implementovat v rámci programu \texttt{JHOVE2} dal¹í tøídu.

Moje nová tøída je spu¹tìna pøímo z programu \texttt{arc2warc.py}\footnote{Souèást nástroje \texttt{WARC-TOOLS}, která je urèena k migraci archivù. Do jiných programù v rámci \texttt{WARC-TOOLS} jsem nemusel zasahovat.}. Poté co inicializuje nástroj \texttt{JHOVE2}, pøedává mu pomocí metody \texttt{runJHOVE2\-Loop} jednotlivé soubory k testování. Mnou implementovaná tøída tedy opìt umo¾òuje testování více souborù, pøièem¾ není nutné spou¹tìt \texttt{JHOVE2} vícekrát.

Pøi implementaci jsem objevil ne pøíli¹ vá¾nou chybu v nástroji: nástroj vypisuje nìkteré chybové hlá¹ky na standardní výstup. Chyba by byla záva¾ná, pokud by se na ni nepøi¹lo a bìhem provádìní migraèního nástroje by se chybové hlá¹ky vypisovaly do tìla \texttt{warc} archivu. V takovém pøípadì by mohlo dojít ke zbyteènému po¹kození archivu. Tuto chybu jsem tedy jednodu¹e odstranil pøesmìrováním výstupù do souboru.

Dále jsem zjistil, ¾e nástroj pøi pou¾ívání modulu \texttt{XmlFormat} zpracovává nìteré soubory neúmìrnì dlouho. Jednalo se o soubory, které obsahovaly napøíklad data ve formì CDATA. Proto mi vedoucí práce, Mgr. Václav Rosecký, doporuèil daný modul odstranit. Jeho absence nebude mít výrazný vliv na validování obsahu souborù.

Poslední problém, který jsem objevil u nástroje \texttt{JHOVE2}, je to, ¾e v nìm vzniká chyba pøi testování archivù -- nástroj vyhazuje výjimku. Bylo kvùli tomu nutné upravit nástroj \texttt{arc2warc}.py tak, aby výjimky neohrozily bìh migrace.

Ukázku této tøídy je mo¾no najít v \texttt{pøíloze AK a na s. \pageref{pr:ak}}, kompletní implementovaný nástroj je k nalezení v \texttt{pøíloze AQ na s. \pageref{pr:aq}}.
\section{Úprava \texttt{WARC-TOOLS / hanzo}}
Pøi úpravì nástroje \texttt{WARC-TOOLS} staèilo upravit pouze \texttt{arc2warc.py}, který je implementován v programovacím jazyce \texttt{Python}. Bylo nutné provést takové zmìny, aby bylo mo¾no pøímo pøi bìhu programu spustit aplikaci v programovacím \texttt{Java}. A upravit program tak, aby bylo mo¾no pøistupovat k jednotlivým souborùm uvnitø \texttt{arc} archivu. Dal¹ím problémem bylo, ¾e program \texttt{JHOVE2} neumo¾òuje vícenásobné spu¹tìní. Opakovaná inicializace by v¹ak byla výpoèetnì velmi nároèná\footnote{Typický archiv je má velikost 100 MB a obsahuje stovky a¾ tisíce souborù.}.

Pro úèely spou¹tìní \texttt{Java} aplikace v rámci skriptu v jazyce \texttt{Python} bylo tøeba vybrat vhodný nástroj. Vybíral jsem mezi nástroji \texttt{Jpype} a \texttt{Jython}\footnote{Webové stránky projektu \texttt{JYTHON} dostupné online na adrese \texttt{http://www.jython.org}.}. Nástroj \texttt{Jpype} umo¾òuje spu¹tìní \texttt{Java Virtual Machine} uvnitø skriptu v jazyce \texttt{Python}, oproti tomu nástroj \texttt{Jython} spustí \texttt{Java Virtual Machine} je¹tì pøed samotným vykonáváním skriptu. Nakonec jsem zvolil nástroj \texttt{Jpype}, který mi pøipadal vhodnìj¹í. Hlavnì proto¾e v dobì volby nástroje jsem se domníval, ¾e budu potøebovat spou¹tìt \texttt{Java Virtual Machine} vícekrát bìhem prùbìhu skriptu.

Pùvodní program pøevádí \texttt{arc} archiv tak, ¾e pøedìlá metadata uvnitø archivu a jeho obsah -- soubory v nìm obsa¾ené -- jako \texttt{bytestream} pøevede do nového \texttt{warc} archivu. Mùj výsledný upravený program pracuje tak, ¾e bìhem pøevodu archivu provede pomocí regulárního výrazu filtrování jednotlivých souborù uvnitø archivu. Ty ulo¾í do doèasného adresáøe a volá na nì nástroj \texttt{JHOVE2} z tìla skriptu \texttt{arc2warc} pøedtím, ne¾ je provedeno zaøazení souboru do nového archivu. Nakonec jsou soubory z doèasného adresáøe odstranìny.

Upravený program pod názvem \texttt{arc2warc\_jhove.py} nabízím v \texttt{pøí\-loze AL na s. \pageref{pr:al}}, kde jsou i moje komentáøe k úpravám zdrojového kódu.
\section{Výstupy z analýzy obsahu pøevádìných archivù}
\begin{table}[htbp!]
\caption{Èasy migrace souborù}
\label{tabulka_obsahu_webarchivu}
\begin{center}
\begin{tabular}{|l||c|c|c|c|c|}
\hline
\textbf{Pokus}&\textbf{Souborù}&\textbf{\texttt{WARC-TOOLS}}&S \textbf{\texttt{JHOVE2}}&\textbf{validace}\\
\hline
1	&	3 682&	31 s&	2 m 50 s&	10 s\\
2	&	4 045&	32 s&	2 m 25 s&	12 s\\
3	&	6 382&	31 s&	2 m 10 s&	x\\
4	&	5 754&	38 s&	2 m 5 s	&	13 s\\
5	&	10 372&	42 s&	3 m 9 s	&	x\\
6	&	11 681&	36 s&	3 m 16 s&	x\\
7	&	7 472&	29 s&	2 m 40 s&	12 s\\
8	&	10 113&	22 s&	3 m 0 s&	x\\
9	&	8 307&	33 s&	2 m 39 s&	x\\
10	&	707&	22 s&	56s	&	7 s\\
\hline
Prùmìr	&	x&	32 s&	2m 31 s&	10 s\\
\hline
\end{tabular}
\end{center}
\end{table}
Svùj program \texttt{arc2warc\_jhove.py} jsem otestoval pøi pøevodu nìkolika souborù \texttt{arc.gz}, které jsem pomocí nástroje \texttt{Heritrix} sám sklidil a nìkolika archivù z repozitáøe WebArchvivu.  V \texttt{pøíloze AP na s. \pageref{pr:ap}} nabízím \texttt{warc} soubor, který vznil pøevodem testovacího \texttt{arc.gz} archivu z \texttt{pøílohy E na s. \pageref{pr:e}}. 

Jak se dalo pøedem oèekávat, migrace spojená s testováním obsahu archivu je èasovì velmi nároèná. V následující tabulce podávám pøehled výsledkù testování. Je evidentní, ¾e migrace bez analýzy archivu pomocí nástroje \texttt{JHOVE2} bude mnohem rychlej¹í. \footnote{Musím zdùraznit, ¾e jsem testování provádìl na svém osobním poèítaèi s parametry: \texttt{Intel Core 2 Duo CPU T7100 @ 1.80GHz * 2, 2 GB RAM, Linux 3.0.0-19-generic 32-bit}. Reálná èísla pøi pou¾ití nástroje na strojích WebArchivu by byla jistì rozdílná. Dùle¾itý je zde pouze pomìr èasu s u¾itím nástroje \texttt{JHOVE2} a bez nìj.}.

K zefektivnìní nástroje by se pravdìpodobnì dalo dojít tak, ¾e by se v rámci nástroje \texttt{JHOVE2} implementovala tøída, která by umo¾nila pøímou charakterizaci souborù, bez nutnosti vytváøení doèasných souborù na disku. Taková zmìna v¹ak není vzhledem k rozsahu nástroj \texttt{JHOVE2} jednoduchá. V souèasné implementace funguje nástroj tak, ¾e i kdy¾ dostane na vstup \texttt{bytestream}, vytvoøí z nìj doèasný soubor. Nástroj \texttt{JHOVE2} je vyvíjen týmem lidí, který mìl zøejmì dùvod takovouto u¾iteènou funkcionalitu neimplementovat.

V následující tabulce uvádím èasy na zpracování archivù a poznámky z testovaných archivù. Pou¾il jsem rùzné archivy z repozitáøe WebArchivu a jeden sta¾ený pøímo mnou, v¹echny mìly velikost 100 MB. U nìkterých neuvádím èas validace vzniklého \texttt{warc} archivu. Jedná se o ty, které migraèní nástroj nepøevedl správnì -- haváriím pøevodu se vìnuji v následující kapitole. V \texttt{pøíloze AS na s. \pageref{pr:as}} jsou v¹echny testované soubory vèetnì výsledných \texttt{warc} souborù.
\section{Havárie nástroje \texttt{WARC-TOOLS / hanzo}}
Pøi implementaci a testování migrace archivu jsem narazil na záva¾nou chybu. Nìkteré mnou testované \texttt{arc.gz} archivy z repozitáøe WebArchivu nástroj \texttt{arc2warc.py} nedokázal pøevést. Nástroj nahlásil závadu \texttt{INCORECT HEADER CHECK} a ukonèil migraci archivu. Tuto závadu jsem nakonec odstranil tím, ¾e jsem pou¾il nejnovìj¹í verzi \texttt{WARC-TOOLS / hanzo}.

Nová verze ji¾ na testovaných archivech nehlásí chybu pøi procesu migrace, ale migrované soubory jsou po kontrole nástrojem \texttt{warc}index.py oznaèeny jako nevalidní. Zjistil jsem, ¾e dokonce existuje rozdíl v chybové hlá¹ce podle toho, jakým zpùsobem se nástroj spou¹tí z pøíkazové øádky. Podle dokumentace se nástroj má spou¹tìt z pøíkazové øádky tak, ¾e jako parametr za pøepínaèem \texttt{'-o'} se zadá cesta k výslednému \texttt{warc.gz} archivu. Tento zpùsob v¹ak u vìt¹iny mnou testovaných archivù vedl právì k nevalidním výsledným archivùm.

Dále jsem tedy zjistil, ¾e pøi spou¹tìní z pøíkazové øádky a pøesmìrování standardního výstupu \texttt{('>')} do cílového \texttt{warc.gz} archivu vede k lep¹ím výsledkùm -- z mnou testovaných archivù jich je více validních. Pøesto v¹ak jsem mìl k dispozici \texttt{arc.gz} archivy, které pøi migraci pøes obì varianty hlásily nevalidní výsledné \texttt{warc} archivy.

Chyba, kterou validátor hlásil, byla buï: \texttt{('incorrect trailing newline', '$\backslash$n')}, anebo \texttt{('incorrect trailing newline', '$\backslash$r')}. Jedná se vlastnì o chybu v kódování nového øádku ve výsledných souborech\footnote{Konec øádkù se typicky znaèí buï znakem \texttt{CR} -- zkratka \texttt{CR} znamená \texttt{Carriage Return} --, nebo \texttt{LF} -- zkratka \texttt{LF} znamená \texttt{Line Feed} --, nebo jejich kombinací. V Unixovský operaèních systémech se u¾ívá \texttt{CR}, v systémech vycházejících z \texttt{CP/M} se u¾ívá \texttt{CR+LF} a v systémech Commodore a Apple se u¾ívá \texttt{LF}.}. 

Proto jsem se rozhodl po dohodì s vedoucím práce informovat o této skuteènosti vývojáøe nástroje. Dokud nebude tato chyba opravena, nedoporuèuji nástroj pou¾ívat. V \texttt{pøíloze AR na s. \pageref{pr:ar}} je k dohledání hlá¹ení o chybì. 
\section{Dal¹í nástroje sady \texttt{WARC-TOOLS / hanzo}}
Jak bylo øeèeno ji¾ vý¹e, \texttt{WARC-TOOLS / hanzo} je sada nástrojù. Kromì migraèního nástroje obsahuje i nástroje pro práci s \texttt{warc} archivy. Nìkteré z nich jsou pro projekt WebArchiv dùle¾ité. V následující kapitole o nich podám nìkolik základních informací a doporuèení.
\subsection{\texttt{warcindex.py}}
Tento nástroj slou¾í k vytvoøení \texttt{CDX indexu} pro \texttt{warc} archivy. Jak jsem ji¾ zmiòoval, \texttt{CDX indexy} slou¾í k interpretaci dat z archivù pomocí nástroje \texttt{Wayback}. \texttt{CDX indexy} jsou také pou¾ít k porovnání obsahu \texttt{arc} a \texttt{warc} archivù vzniklých migrací. Tím lze kontrolovat úspì¹nost provedené migrace. Nástroj \texttt{warcindex.py} doporuèuji k vytváøení \texttt{CDX indexù warc} souborù.
\subsection{\texttt{warcvalid.py}}
Dal¹ím dùle¾itým nástrojem je nástroj \texttt{warcvalid.py}. Tento nástroj slou¾í k validaci \texttt{warc} archivù, jeví se jako vhodný pro kontrolu validity nových \texttt{warc} archivù vzniklých pøi migraci. Díky nástroji jsem odhalil problémy s migraèním nástrojem, který popisuju v kapitole vìnované haváriím nástroje. Nástroj doporuèuji k ovìøování validity \texttt{warc} archivù.
\section{Doporuèení pro implementaci migrace archivu}
Jak jsem ji¾ zmínil v èásti práce, ve které se vìnuji rùzným migraèním nástrojùm, doporuèuji nástroj \texttt{WARC-TOOLS / hanzo} k realizaci migrace archivu WebArchiv. Musím ale zdùraznit, ¾e nástroj je¹tì není spolehlivì implementován. Pøed samotným pou¾itím je potøeba zajistit, aby v¹echny soubory, které jím budou pøevádìny, byly validní.

Jak jsem ukázal v kapitole, ve které se zabývám havárií nástroje, existují archivy, které jím nejsou pøevedeny spolehlivì. A¾ bude odstranìn zmínìný nedostatek, doporuèuji provést je¹tì nìkolik ovìøení migraèního nástroje. Migrace celého archivu bude èasovì i výpoèetnì velmi nároènou operací a je nutné zajistit, aby pøi ní nedo¹lo k ¾ádným komplikacím.